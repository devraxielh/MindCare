{% extends 'base.html' %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<h2>Panel de Administraci√≥n</h2>
<p>Resumen de resultados de encuestas recolectados.</p>

<!-- Filters -->
<form method="get"
    style="background: #f8f9fa; padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; align-items: end;">
    <div>
        <label style="font-weight: bold; display: block; margin-bottom: 0.5rem;">G√©nero</label>
        <select name="gender" id="select-gender" autocomplete="off">
            <option value="">Todos</option>
            {% for g in all_genders %}
            <option value="{{ g }}" {% if current_filters.gender == g %}selected{% endif %}>{{ g }}</option>
            {% endfor %}
        </select>
    </div>
    <div>
        <label style="font-weight: bold; display: block; margin-bottom: 0.5rem;">Pa√≠s</label>
        <select name="country" id="select-country" autocomplete="off">
            <option value="">Todos</option>
            {% for c in all_countries %}
            <option value="{{ c }}" {% if current_filters.country == c %}selected{% endif %}>{{ c }}</option>
            {% endfor %}
        </select>
    </div>
    <div>
        <label style="font-weight: bold; display: block; margin-bottom: 0.5rem;">Predicci√≥n</label>
        <select name="prediction" id="select-prediction" autocomplete="off">
            <option value="">Todos</option>
            <option value="Yes" {% if current_filters.prediction == 'Yes' %}selected{% endif %}>Tratamiento Recomendado
            </option>
            <option value="No" {% if current_filters.prediction == 'No' %}selected{% endif %}>No Requiere Tratamiento
            </option>
        </select>
    </div>
    <div style="display: flex; gap: 0.5rem;">
        <button type="submit">Filtrar</button>
        <a href="{% url 'dashboard' %}"
            style="padding: 1rem; color: #777; text-decoration: underline; align-self: center;">Limpiar</a>
    </div>
</form>

<script>
    new TomSelect("#select-gender", {
        create: false,
        sortField: {
            field: "text",
            direction: "asc"
        }
    });
    new TomSelect("#select-country", {
        create: false,
        sortField: {
            field: "text",
            direction: "asc"
        }
    });
    new TomSelect("#select-prediction", {
        create: false,
        sortField: {
            field: "text",
            direction: "asc"
        }
    });
</script>

<!-- Stats Cards -->
<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 2rem;">
    <div
        style="background: var(--primary-color); color: white; padding: 1.5rem; border-radius: 8px; text-align: center;">
        <h3 style="color: white; margin-bottom: 0.5rem;">{{ total }}</h3>
        <p style="color: white; margin: 0;">Total de Respuestas</p>
    </div>
    <div style="background: var(--danger); color: white; padding: 1.5rem; border-radius: 8px; text-align: center;">
        <h3 style="color: white; margin-bottom: 0.5rem;">{{ positive }}</h3>
        <p style="color: white; margin: 0;">Requiere Tratamiento</p>
    </div>
    <div
        style="background: var(--secondary-color); color: white; padding: 1.5rem; border-radius: 8px; text-align: center;">
        <h3 style="color: white; margin-bottom: 0.5rem;">{{ negative }}</h3>
        <p style="color: white; margin: 0;">No Requiere Tratamiento</p>
    </div>
</div>


<!-- Tab Navigation -->
<div style="margin-bottom: 2rem;">
    <div style="display: flex; gap: 0.5rem; border-bottom: 2px solid #eee; margin-bottom: 2rem;">
        <button onclick="switchTab('estadisticas')" id="tab-estadisticas"
            style="padding: 1rem 2rem; background: var(--primary-color); color: white; border: none; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: bold; transition: all 0.3s;">
            üìä Estad√≠sticas
        </button>
        <button onclick="switchTab('respuestas')" id="tab-respuestas"
            style="padding: 1rem 2rem; background: #f0f0f0; color: #666; border: none; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: bold; transition: all 0.3s;">
            üìã Respuestas Recientes
        </button>
    </div>

    <!-- Tab Content: Estad√≠sticas -->
    <div id="content-estadisticas" style="display: block;">
<!-- Charts -->
<div
    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 2rem; margin-bottom: 2rem;">
    <div
        style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid #eee;">
        <h3 style="text-align: center; margin-bottom: 1rem;">Distribuci√≥n por G√©nero</h3>
        <canvas id="genderChart"></canvas>
    </div>
    <div
        style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid #eee;">
        <h3 style="text-align: center; margin-bottom: 1rem;">% Tratamiento por Historial Familiar</h3>
        <canvas id="famHistoryChart"></canvas>
    </div>
</div>

<script>
    // Gender Chart
    const ctxGender = document.getElementById('genderChart').getContext('2d');
    new Chart(ctxGender, {
        type: 'doughnut',
        data: {
            labels: {{ gender_labels| safe }},
        datasets: [{
            data: {{ gender_data| safe }},
        backgroundColor: ['#5D5CDE', '#38bfa1', '#e76f51', '#f4a261', '#2a9d8f'],
            }]
        }
    });

    // Family History Chart
    const ctxFam = document.getElementById('famHistoryChart').getContext('2d');
    new Chart(ctxFam, {
        type: 'bar',
        data: {
            labels: {{ fam_hist_labels| safe }},
        datasets: [{
            label: '% Requiere Tratamiento',
            data: {{ fam_hist_values| safe }},
        backgroundColor: ['#e76f51', '#38bfa1'],
            }]
        },
        options: {
        scales: {
            y: {
                beginAtZero: true,
                max: 100
            }
        }
    }
    });
</script>

<!-- Dynamic Question Charts -->
<h3 style="margin-top: 3rem; margin-bottom: 2rem; border-bottom: 2px solid #eee; padding-bottom: 0.5rem;">Estad√≠sticas
    Detalladas por Pregunta</h3>
<div
    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 2rem; margin-bottom: 3rem;">
    {% for field, stats in question_stats.items %}
    <div
        style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid #eee;">
        <h4
            style="text-align: center; margin-bottom: 1rem; color: #555; height: 3rem; display: flex; align-items: center; justify-content: center;">
            {{ stats.verbose_name }}</h4>
        <canvas id="{{ stats.id }}"></canvas>
    </div>
    {% endfor %}
</div>

<script>
    {% for field, stats in question_stats.items %}
    new Chart(document.getElementById('{{ stats.id }}').getContext('2d'), {
        type: 'bar',
        data: {
            labels: {{ stats.labels | safe }},
        datasets: [{
            label: 'Respuestas',
            data: {{ stats.data | safe }},
        backgroundColor: '#38bfa1', // Teal color for bars
        borderRadius: 4
            }]
        },
        options: {
        responsive: true,
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            }
        },
        plugins: {
            legend: {
                display: false
            }
        }
    }
    });
    {% endfor %}
</script>

    </div>
    <!-- End Tab Content: Estad√≠sticas -->

    <!-- Tab Content: Respuestas -->
    <div id="content-respuestas" style="display: none;">
<h3>Respuestas Recientes</h3>
<table style="width: 100%; border-collapse: collapse; margin-top: 1rem;">
    <thead>
        <tr style="background: #eee;">
            <th style="padding: 0.8rem; text-align: left;">Usuario</th>
            <th style="padding: 0.8rem; text-align: left;">Fecha</th>
            <th style="padding: 0.8rem; text-align: left;">Predicci√≥n (Tratamiento)</th>
        </tr>
    </thead>
    <tbody>
        {% for resp in responses %}
        <tr style="border-bottom: 1px solid #eee;">
            <td style="padding: 0.8rem;">{{ resp.user.username }}</td>
            <td style="padding: 0.8rem;">{{ resp.timestamp|date:"d/m/Y H:i" }}</td>
            <td
                style="padding: 0.8rem; color: {% if resp.prediction == 'Yes' %}var(--danger){% else %}var(--secondary-color){% endif %}; font-weight: bold;">
                {% if resp.prediction == 'Yes' %}S√≠{% else %}No{% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Pagination Controls -->
{% if responses.has_other_pages %}
<div
    style="display: flex; justify-content: center; align-items: center; gap: 0.5rem; margin-top: 2rem; flex-wrap: wrap;">
    {% if responses.has_previous %}
    <a href="?page=1&tab=respuestas{% if current_filters.gender %}&gender={{ current_filters.gender }}{% endif %}{% if current_filters.country %}&country={{ current_filters.country }}{% endif %}{% if current_filters.prediction %}&prediction={{ current_filters.prediction }}{% endif %}"
        style="padding: 0.5rem 1rem; background: #f0f0f0; border-radius: 4px; text-decoration: none; color: #333;">Primera</a>
    <a href="?page={{ responses.previous_page_number }}&tab=respuestas{% if current_filters.gender %}&gender={{ current_filters.gender }}{% endif %}{% if current_filters.country %}&country={{ current_filters.country }}{% endif %}{% if current_filters.prediction %}&prediction={{ current_filters.prediction }}{% endif %}"
        style="padding: 0.5rem 1rem; background: #f0f0f0; border-radius: 4px; text-decoration: none; color: #333;">‚Üê
        Anterior</a>
    {% endif %}

    <span style="padding: 0.5rem 1rem; color: #555;">
        P√°gina {{ responses.number }} de {{ responses.paginator.num_pages }}
    </span>

    {% if responses.has_next %}
    <a href="?page={{ responses.next_page_number }}&tab=respuestas{% if current_filters.gender %}&gender={{ current_filters.gender }}{% endif %}{% if current_filters.country %}&country={{ current_filters.country }}{% endif %}{% if current_filters.prediction %}&prediction={{ current_filters.prediction }}{% endif %}"
        style="padding: 0.5rem 1rem; background: #f0f0f0; border-radius: 4px; text-decoration: none; color: #333;">Siguiente
        ‚Üí</a>
    <a href="?page={{ responses.paginator.num_pages }}&tab=respuestas{% if current_filters.gender %}&gender={{ current_filters.gender }}{% endif %}{% if current_filters.country %}&country={{ current_filters.country }}{% endif %}{% if current_filters.prediction %}&prediction={{ current_filters.prediction }}{% endif %}"
        style="padding: 0.5rem 1rem; background: #f0f0f0; border-radius: 4px; text-decoration: none; color: #333;">√öltima</a>
    {% endif %}
</div>
{% endif %}
    </div>
    <!-- End Tab Content: Respuestas -->
</div>
<!-- End Tab Navigation -->

<script>
function switchTab(tabName) {
    // Hide all tab contents
    document.getElementById('content-estadisticas').style.display = 'none';
    document.getElementById('content-respuestas').style.display = 'none';
    
    // Reset all tab buttons
    document.getElementById('tab-estadisticas').style.background = '#f0f0f0';
    document.getElementById('tab-estadisticas').style.color = '#666';
    document.getElementById('tab-respuestas').style.background = '#f0f0f0';
    document.getElementById('tab-respuestas').style.color = '#666';
    
    // Show selected tab content and highlight button
    if (tabName === 'estadisticas') {
        document.getElementById('content-estadisticas').style.display = 'block';
        document.getElementById('tab-estadisticas').style.background = 'var(--primary-color)';
        document.getElementById('tab-estadisticas').style.color = 'white';
    } else if (tabName === 'respuestas') {
        document.getElementById('content-respuestas').style.display = 'block';
        document.getElementById('tab-respuestas').style.background = 'var(--primary-color)';
        document.getElementById('tab-respuestas').style.color = 'white';
    }
}

// Check URL parameter on page load to activate correct tab
window.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const tabParam = urlParams.get('tab');
    
    if (tabParam === 'respuestas') {
        switchTab('respuestas');
    } else {
        switchTab('estadisticas');
    }
});
</script>

{% endblock %}