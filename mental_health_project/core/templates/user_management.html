{% extends 'base.html' %}

{% block content %}
<h2>Gesti√≥n de Usuarios</h2>
<p>Administra los usuarios del sistema.</p>

<!-- Search Bar -->
<form method="get" style="margin-top: 2rem; margin-bottom: 1rem;">
    <div style="display: flex; gap: 1rem; align-items: center;">
        <input type="text" name="search" value="{{ search_query }}"
            placeholder="Buscar por nombre de usuario, email o nombre..."
            style="flex: 1; padding: 0.8rem; border: 1px solid #ddd; border-radius: 4px;">
        <button type="submit" style="padding: 0.8rem 2rem;">Buscar</button>
        {% if search_query %}
        <a href="{% url 'user_management' %}"
            style="padding: 0.8rem 1rem; background: #f0f0f0; border-radius: 4px; text-decoration: none; color: #666;">Limpiar</a>
        {% endif %}
    </div>
</form>

<!-- Users Table -->
<table style="width: 100%; border-collapse: collapse; margin-top: 1rem;">
    <thead>
        <tr style="background: #eee;">
            <th style="padding: 0.8rem; text-align: left;">Usuario</th>
            <th style="padding: 0.8rem; text-align: left;">Email</th>
            <th style="padding: 0.8rem; text-align: left;">Nombre</th>
            <th style="padding: 0.8rem; text-align: center;">Rol</th>
            <th style="padding: 0.8rem; text-align: center;">Estado</th>
            <th style="padding: 0.8rem; text-align: center;">Acciones</th>
        </tr>
    </thead>
    <tbody>
        {% for user in users %}
        <tr style="border-bottom: 1px solid #eee;" id="user-row-{{ user.id }}">
            <td style="padding: 0.8rem;">
                <strong>{{ user.username }}</strong>
            </td>
            <td style="padding: 0.8rem;">{{ user.email|default:"‚Äî" }}</td>
            <td style="padding: 0.8rem;">
                {% if user.first_name or user.last_name %}
                {{ user.first_name }} {{ user.last_name }}
                {% else %}
                ‚Äî
                {% endif %}
            </td>
            <td style="padding: 0.8rem; text-align: center;">
                <span id="role-badge-{{ user.id }}"
                    style="padding: 0.3rem 0.8rem; border-radius: 12px; font-size: 0.85rem; font-weight: bold;
                             {% if user.is_superuser %}background: var(--danger); color: white;{% else %}background: #e0e0e0; color: #666;{% endif %}">
                    {% if user.is_superuser %}Admin{% else %}Usuario{% endif %}
                </span>
            </td>
            <td style="padding: 0.8rem; text-align: center;">
                <span
                    style="padding: 0.3rem 0.8rem; border-radius: 12px; font-size: 0.85rem;
                             {% if user.is_active %}background: var(--secondary-color); color: white;{% else %}background: #ccc; color: #666;{% endif %}">
                    {% if user.is_active %}Activo{% else %}Inactivo{% endif %}
                </span>
            </td>
            <td style="padding: 0.8rem; text-align: center;">
                <div style="display: flex; gap: 0.5rem; justify-content: center;">
                    <a href="{% url 'edit_user' user.id %}"
                        style="padding: 0.5rem 1rem; background: var(--primary-color); color: white; border-radius: 4px; text-decoration: none; font-size: 0.9rem;">
                        ‚úèÔ∏è Editar
                    </a>
                    <button onclick="toggleRole({{ user.id }}, '{{ user.username }}')" id="toggle-btn-{{ user.id }}" {% if user.id == request.user.id %}disabled title="No puedes cambiar tu propio rol"{% endif %}
                        style="padding: 0.5rem 1rem; background: {% if user.id == request.user.id %}#ccc{% else %}var(--secondary-color){% endif %}; color: white; border: none; border-radius: 4px; cursor: {% if user.id == request.user.id %}not-allowed{% else %}pointer{% endif %}; font-size: 0.9rem;">
                        üîÑ Cambiar Rol
                    </button>
                </div>
            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="6" style="padding: 2rem; text-align: center; color: #999;">
                {% if search_query %}
                No se encontraron usuarios que coincidan con "{{ search_query }}"
                {% else %}
                No hay usuarios registrados
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>



<!-- Pagination -->
{% if users.has_other_pages %}
<div
    style="display: flex; justify-content: center; align-items: center; gap: 0.5rem; margin-top: 2rem; flex-wrap: wrap;">
    {% if users.has_previous %}
    <a href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}"
        style="padding: 0.5rem 1rem; background: #f0f0f0; border-radius: 4px; text-decoration: none; color: #333;">Primera</a>
    <a href="?page={{ users.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}"
        style="padding: 0.5rem 1rem; background: #f0f0f0; border-radius: 4px; text-decoration: none; color: #333;">‚Üê
        Anterior</a>
    {% endif %}

    <span style="padding: 0.5rem 1rem; color: #555;">
        P√°gina {{ users.number }} de {{ users.paginator.num_pages }}
    </span>

    {% if users.has_next %}
    <a href="?page={{ users.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}"
        style="padding: 0.5rem 1rem; background: #f0f0f0; border-radius: 4px; text-decoration: none; color: #333;">Siguiente
        ‚Üí</a>
    <a href="?page={{ users.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}"
        style="padding: 0.5rem 1rem; background: #f0f0f0; border-radius: 4px; text-decoration: none; color: #333;">√öltima</a>
    {% endif %}
</div>
{% endif %}

<script>
    function toggleRole(userId, username) {
        if (!confirm(`¬øEst√°s seguro de que quieres cambiar el rol de ${username}?`)) {
            return;
        }

        fetch(`/users/toggle-role/${userId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            },
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update the role badge
                    const badge = document.getElementById(`role-badge-${userId}`);
                    if (data.is_superuser) {
                        badge.textContent = 'Admin';
                        badge.style.background = 'var(--danger)';
                        badge.style.color = 'white';
                    } else {
                        badge.textContent = 'Usuario';
                        badge.style.background = '#e0e0e0';
                        badge.style.color = '#666';
                    }

                    // Show success message
                    alert(`Rol de ${data.username} actualizado exitosamente.`);
                } else {
                    alert(`Error: ${data.error}`);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Ocurri√≥ un error al cambiar el rol del usuario.');
            });
    }
</script>

{% endblock %}